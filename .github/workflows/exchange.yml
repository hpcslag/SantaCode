name: Gift Exchange (Admin Only)

on:
  workflow_dispatch:
    inputs:
      confirm_exchange:
        description: 'Type "MERRY CHRISTMAS" to confirm exchange'
        required: true

jobs:
  exchange:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_exchange == 'MERRY CHRISTMAS'
    timeout-minutes: 60  # Ensure enough time for 100+ sequential executions
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Pre-pull Docker Images
        run: |
          echo "Pre-warming Docker cache..."
          # Pulling largest images first
          docker pull swift:5.8-slim &
          docker pull rust:slim &
          docker pull gcc:12 &
          docker pull eclipse-temurin:17-jdk &
          docker pull mcr.microsoft.com/dotnet/sdk:8.0 &
          docker pull zenika/kotlin:latest &
          docker pull python:3.13-slim &
          docker pull node:18-alpine &
          docker pull alpine:3.18 &
          docker pull golang:1.23-alpine &
          docker pull ruby:3.3-alpine &
          wait
          echo "All images prepared!"

      - name: Run Exchange Logic
        run: |
          echo "Starting the Great SantaCode Exchange..."
          python3 core/exchange.py
          
      - name: Upload Match Report
        uses: actions/upload-artifact@v4
        with:
          name: secret-santa-matches-report
          path: match_report.csv
